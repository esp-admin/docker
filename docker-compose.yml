version: '3'

networks:
  db-link:
    driver: bridge
  tunnel-link:
    driver: bridge

services:
  mongodb:
    container_name: mongodb
    build: .
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=prisma
      - MONGO_REPLICA_HOST=localhost
      - MONGO_REPLICA_PORT=27018
    volumes:
      - ./mongodb:/data/db
    networks:
      - db-link

  nuxt:
    container_name: nuxt
    image: becemgharbi/esp-admin
    env_file: .env
    depends_on:
      - mongodb
    environment:
      - DATABASE_URL=mongodb://root:prisma@mongodb:27018/esp-admin?directConnection=true&authSource=admin
    volumes:
      - ./uploads:/src/uploads
    networks:
      - db-link
      - tunnel-link

  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARED_TUNNEL_TOKEN}
    depends_on:
      - nuxt
    networks:
      - tunnel-link
  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - "./mosquitto/data:/mosquitto/data"
      - "./mosquitto/log:/mosquitto/log"
      - "./mosquitto/config:/mosquitto/config"
